#!/bin/sh
##############################################################################
#
# Purpose: Check that configure.in/configure always get updated together.
#          Also, check that correct version of autoconf was used to
#          generate configure.
#
# Programmer: Mark C. Miller
# Created:    Mon Apr  7 18:16:51 PDT 2008
#
# Modifications:
#
#   Tom Fogal, Tue Jun 24 11:55:51 EDT 2008
#   Added a bypass/allow for modifying configure if you've modified any m4
#   files.  Also, 's/\t/\ \ \ \ /g'
#
#   Mark C. Miller, Tue Nov 18 18:22:40 PST 2008
#   Fixed typo in logic involving || for $m4_file
#
#   Mark C. Miller, Mon Dec  8 12:51:21 PST 2008
#   Fixed typo in logic involving && for $m4_file
#
#   Mark C. Miller, Tue Dec  9 00:19:04 PST 2008
#   Obtain list of changed files via FLIST ($3) argument and loop
#   over them via 'read' sh builtin method.
#
#   Mark C. Miller, Tue Dec  9 23:08:23 PST 2008
#   Adjusted file loop to deal with fact that FLIST file now contains
#   both status chars and filename. Replaced ${<VARNAME>} command refs
#   with just the commands themselves.
##############################################################################
REPOS="$1"
TXN="$2"
FLIST="$3"

theConfigureFile=""
theConfigureDotInFile=""
m4_file=""
while read fline; do

    #
    # Get file 'svnlook' status and name
    #
    fstat=`echo $fline | tr -s ' ' | cut -d' ' -f1`
    fname=`echo $fline | tr -s ' ' | cut -d' ' -f2`

    #
    # We're looking for only these specific files
    # for this hook.
    case $fname in
        *src/configure.in)
            theConfigureDotInFile=$fname
            ;;
        *src/*m4)
            m4_file=$fname
            ;;
        *src/configure)
            theConfigureFile=$fname
            ;;
    esac

done < $FLIST

# Check that both configure.in and configure are getting updated
if test -n "$theConfigureDotInFile" || test -n "$m4_file"; then
    if test -z "$theConfigureFile"; then
        log "Attempt to update \"configure.in\" without also updating \"configure\""
        exit 1
    fi
elif test -n "$theConfigureFile"; then
    if test -z "$theConfigureDotInFile" && test -z "$m4_file" ; then
        log "Attempt to update \"configure\" without also updating \"configure.in\""
        exit 1
    fi
fi

# get and check autoconf version number
if test -n "$theConfigureFile"; then
    acVno=`svnlook cat -t $TXN $REPOS $theConfigureFile | grep 'Generated by GNU Autoconf' | tr -s ' ' | cut -d' ' -f6 | cut -d'.' -f1,2`
    if test "$acVno" != "$AUTOCONF_VERSION_NUMBER"; then
        log "You must use autoconf version $AUTOCONF_VERSION_NUMBER to re-generate configure."
        log "You have used $acVno"
        exit 1
    fi
fi

# all is well!
exit 0
