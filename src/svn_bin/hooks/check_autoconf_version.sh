#!/bin/bash

SVNLOOK="/usr/bin/svnlook"
AWK="/usr/bin/awk"
ACVNO="2.59"

REPOS="$1"
TXN="$2"

function log()
{
    echo "$@" 1>&2
}

if [ -z "${REPOS}" ]; then
    log "Repository path not given, bailing out."
    exit 1
fi
if [ -z "${TXN}" ]; then
    log "Transaction ID not given, bailing out."
    exit 1
fi

files=`${SVNLOOK} changed -t $TXN $REPOS | ${AWK} '{print $2}'`
theConfigureFile=""
theConfigureDotInFile=""
for f in ${files} ; do
    if test "$f" = configure; then
        theConfigureFile=$f
    elif test "$f" = configure.in; then
        theConfigureDotInFile=$f
    fi
done

# Check that both configure.in and configure are getting updated
if test -n "$theConfigureDotInFile"; then
    if test -z "$theConfigureFile"; then
        log "Attempt to update configure.in without also updating configure"
	exit 1
    fi
fi

# get and check autoconf version number
if test -n "$theConfigureFile"; then
    acVno=`head configure | grep 'Generated by GNU Autoconf' | tr -s ' ' | cut -d' ' -f6 | cut -d'.' -f1,2`
    if test "$acVno" != "$ACVNO"; then
        log "You must use autoconf version $ACVNO to re-generate configure; not $acVno"
	exit 1
    fi
fi

# all is well!
exit 0
