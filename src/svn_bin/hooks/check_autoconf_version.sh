#!/bin/sh
##############################################################################
#
# Purpose: Check that configure.in/configure always get updated together.
#          Also, check that correct version of autoconf was used to
#          generate configure.
#
# Programmer: Mark C. Miller
# Created:    Mon Apr  7 18:16:51 PDT 2008
#
# Modifications:
#
#   Tom Fogal, Tue Jun 24 11:55:51 EDT 2008
#   Added a bypass/allow for modifying configure if you've modified any m4
#   files.  Also, 's/\t/\ \ \ \ /g'
#
#   Mark C. Miller, Tue Nov 18 18:22:40 PST 2008
#   Fixed typo in logic involving || for $m4_file
#
##############################################################################
REPOS="$1"
TXN="$2"

function log()
{
    echo "$@" 1>&2
}

if [ -z "${REPOS}" ]; then
    log "Repository path not given, bailing out."
    exit 1
fi
if [ -z "${TXN}" ]; then
    log "Transaction ID not given, bailing out."
    exit 1
fi

files=`${SVNLOOK} changed -t $TXN $REPOS | ${AWK} '{print $2}'`
theConfigureFile=""
theConfigureDotInFile=""
m4_file=""
for f in ${files} ; do
    case ${f} in
        *src/configure.in)
            theConfigureDotInFile=$f
            ;;
        *src/*m4)
            m4_file=$f
            ;;
        *src/configure)
            theConfigureFile=$f
            ;;
    esac
done

# Check that both configure.in and configure are getting updated
if test -n "$theConfigureDotInFile" || test -n "$m4_file"; then
    if test -z "$theConfigureFile"; then
        log "Attempt to update \"configure.in\" without also updating \"configure\""
        exit 1
    fi
elif test -n "$theConfigureFile"; then
    if test -z "$theConfigureDotInFile" && -z "$m4_file" ; then
        log "Attempt to update \"configure\" without also updating \"configure.in\""
        exit 1
    fi
fi

# get and check autoconf version number
if test -n "$theConfigureFile"; then
    acVno=`${SVNLOOK} cat -t $TXN $REPOS $theConfigureFile | grep 'Generated by GNU Autoconf' | tr -s ' ' | cut -d' ' -f6 | cut -d'.' -f1,2`
    if test "$acVno" != "$AUTOCONF_VERSION_NUMBER"; then
        log "You must use autoconf version $AUTOCONF_VERSION_NUMBER to re-generate configure."
        log "You have used $acVno"
        exit 1
    fi
fi

# all is well!
exit 0
