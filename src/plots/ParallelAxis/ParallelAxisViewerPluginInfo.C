// ************************************************************************* //
//  File: ParallelAxisViewerPluginInfo.C
// ************************************************************************* //

#include <ParallelAxisPluginInfo.h>
#include <avtParallelAxisPlot.h>

#include <avtDatabaseMetaData.h>
#include <ParsingExprList.h>
#include <Expression.h>

#include <InvalidVariableException.h>
#include <ImproperUseException.h>
#include <DebugStream.h>

#include <string.h>

#if defined(__APPLE__)
#define GetViewerInfo ParallelAxis_GetViewerInfo
#endif

// ****************************************************************************
//  Function:  GetViewerInfo
//
//  Purpose:
//    Return a new ViewerPluginInfo for the ParallelAxis plot.
//
//  Programmer: mblair -- generated by xml2info
//  Creation:   Mon Jun 5 18:19:57 PST 2006
//
// ****************************************************************************
extern "C" ViewerPlotPluginInfo* GetViewerInfo()
{
    ParallelAxisViewerPluginInfo::InitializeGlobalObjects();
    return new ParallelAxisViewerPluginInfo;
}

//
// Storage for static data elements.
//
ParallelAxisAttributes *ParallelAxisViewerPluginInfo::clientAtts = NULL;
ParallelAxisAttributes *ParallelAxisViewerPluginInfo::defaultAtts = NULL;
ParallelAxisAttributes *ParallelAxisViewerPluginInfo::fallbackAtts = NULL;

// ****************************************************************************
//  Method:  ParallelAxisViewerPluginInfo::InitializeGlobalObjects
//
//  Purpose:
//    Initialize the plot atts.
//
//  Programmer: mblair -- generated by xml2info
//  Creation:   Mon Jun 5 18:19:57 PST 2006
//
//  Modifications:
//
//      Mark Blair, Fri Aug 18 19:17:00 PDT 2006
//      Added fallback attributes (see InitializePlotAtts).
//
// ****************************************************************************
void
ParallelAxisViewerPluginInfo::InitializeGlobalObjects()
{
    ParallelAxisViewerPluginInfo::clientAtts   = new ParallelAxisAttributes;
    ParallelAxisViewerPluginInfo::defaultAtts  = new ParallelAxisAttributes;
    ParallelAxisViewerPluginInfo::fallbackAtts = new ParallelAxisAttributes;
}

// ****************************************************************************
//  Method: ParallelAxisViewerPluginInfo::GetClientAtts
//
//  Purpose:
//    Return a pointer to the viewer client attributes.
//
//  Returns:    A pointer to the viewer client attributes.
//
//  Programmer: mblair -- generated by xml2info
//  Creation:   Mon Jun 5 18:19:57 PST 2006
//
// ****************************************************************************

AttributeSubject *
ParallelAxisViewerPluginInfo::GetClientAtts()
{
    return clientAtts;
}

// ****************************************************************************
//  Method: ParallelAxisViewerPluginInfo::GetDefaultAtts
//
//  Purpose:
//    Return a pointer to the viewer default attributes.
//
//  Returns:    A pointer to the viewer default attributes.
//
//  Programmer: mblair -- generated by xml2info
//  Creation:   Mon Jun 5 18:19:57 PST 2006
//
// ****************************************************************************

AttributeSubject *
ParallelAxisViewerPluginInfo::GetDefaultAtts()
{
    return defaultAtts;
}

// ****************************************************************************
//  Method: ParallelAxisViewerPluginInfo::SetClientAtts
//
//  Purpose:
//    Set the viewer client attributes.
//
//  Arguments:
//    atts      A pointer to the new client attributes.
//
//  Programmer: mblair -- generated by xml2info
//  Creation:   Mon Jun 5 18:19:57 PST 2006
//
// ****************************************************************************

void
ParallelAxisViewerPluginInfo::SetClientAtts(AttributeSubject *atts)
{
    *clientAtts = *(ParallelAxisAttributes *)atts;
    clientAtts->Notify();
}

// ****************************************************************************
//  Method: ParallelAxisViewerPluginInfo::GetClientAtts
//
//  Purpose:
//    Get the viewer client attributes.
//
//  Arguments:
//    atts      A pointer to return the client default attributes in.
//
//  Programmer: mblair -- generated by xml2info
//  Creation:   Mon Jun 5 18:19:57 PST 2006
//
// ****************************************************************************

void
ParallelAxisViewerPluginInfo::GetClientAtts(AttributeSubject *atts)
{
    *(ParallelAxisAttributes *)atts = *clientAtts;
}

// ****************************************************************************
//  Method: ParallelAxisViewerPluginInfo::AllocAvtPlot
//
//  Purpose:
//    Return a pointer to a newly allocated avt plot.
//
//  Returns:    A pointer to the newly allocated avt plot.
//
//  Programmer: mblair -- generated by xml2info
//  Creation:   Mon Jun 5 18:19:57 PST 2006
//
// ****************************************************************************

avtPlot *
ParallelAxisViewerPluginInfo::AllocAvtPlot()
{
    return new avtParallelAxisPlot;
}


// ****************************************************************************
//  Method: ParallelAxisViewerPluginInfo::ParseArrayComponentVariables
//
//  Purpose: Parses an "array_component" expression.
//
//  Returns: Component variable names in the input expression.
//
//  Note: This is only intended to be used as a stopgap until array variable
//        component information is available in the metadata.
//
//  Programmer: Mark Blair
//  Creation:   Fri Apr 21 17:22:00 PDT 2006
//
// ****************************************************************************

void
ParseArrayComponentVariables(
    stringVector &componentVars, const char *arrayExp)
{
    componentVars.clear();

    if (strncmp(arrayExp, "array_compose", 13) != 0) return;
    
    int tokenLen;
    bool foundAlphanumeric;
    bool badExpression = false;
    char tokenChar;
    char *expCharPtr = (char *)arrayExp + 13;
    char *tokenPtr;
    int parseState = 0;     // Expecting '(' or space
    char token[121];
    
    do {
        tokenPtr = token; tokenLen = 0;
        foundAlphanumeric = false;

        while ((tokenChar = *expCharPtr++) != '\0')
        {
            if (isspace(tokenChar))
            {
                if (tokenLen > 0) parseState = 2; // Expecting ',' or ')' or space
                continue;
            }
            
            if (tokenChar == '(') break;
            if (tokenChar == ')') break;
            if (tokenChar == ',') break;
            
            *tokenPtr++ = tokenChar; tokenLen++;
            
            if (parseState != 1)
                badExpression = true;
            else if (isalnum(tokenChar))
                foundAlphanumeric = true;
            else if (tokenChar != '_')
                badExpression = true;
            
            if (badExpression) break;
        }
        
        if (!badExpression)
        {
            if (tokenChar == '\0')
                badExpression = true;
            else if (tokenChar == '(')
            {
                if (parseState != 0) badExpression = true;
            }
            else if (!foundAlphanumeric)
                badExpression = true;
            else if (isdigit(token[0]))
                badExpression = true;
            else
            {   
                *tokenPtr = '\0';
                componentVars.push_back(std::string(token));
            }
        }

        if (badExpression)
        {
            componentVars.clear();
            return;
        }

        parseState = 1;     // Expecting variable name character or space
    } while (tokenChar != ')');
}


// ****************************************************************************
//  Method: ParallelAxisViewerPluginInfo::InitializePlotAtts
//
//  Purpose:
//    Initialize the plot attributes to the default attributes or a "fallback"
//    set of attributes if the default attributes are not valid and the plot
//    variable makes it possible to define a meaningful set of initial
//    attributes.
//
//  Arguments:
//    atts      The attribute subject to initialize.
//    md        The metadata used to initialize.
//    atts      The variable name used to initialize.
//
//  Programmer: mblair -- generated by xml2info
//  Creation:   Fri Mar 31 16:49:49 PST 2006
//
//  Modifications:
//
//      Mark Blair, Fri Aug 18 19:17:00 PDT 2006
//      Added support for fallback attributes if wizard or CLI has not provided
//      sufficient input attributes (see fuller explanation in code below).
//
// ****************************************************************************

void
ParallelAxisViewerPluginInfo::InitializePlotAtts(AttributeSubject *atts,
    const avtDatabaseMetaData *md, const char *variableName)
{
    // Since a ParallelAxis plot requires at least 2 scalar axis variables,
    // the presence of fewer than 2 in the plot's default attributes indicates
    // that the plot's wizard did not run; the wizard can only be traversed
    // successfully if the user selects at least 2 variables.  This means that
    // either (1) VisIt is running in interactive mode and the wizard recognized
    // that the plot variable is an expression which it assumes will turn out to
    // be an array axpression ("array_compose(v1, v2, . . .)"), or (2) VisIt is
    // running in CLI mode and the user has not set the axis variable list with
    // 2 or more distinct scalar variables.  In either case, it will be assumed
    // that the plot variable is in fact an array expression with at least 2
    // component variable names and an exception will be thrown if this turns
    // not to be true.  (mb)
    
    ParallelAxisAttributes *initAtts = defaultAtts;

    if (defaultAtts->GetOrderedAxisNames().size() < 2)
    {
        stringVector axisNames;
        doubleVector axisMins;
        doubleVector axisMaxs;
        doubleVector extMins;
        doubleVector extMaxs;

        int axisCount, axisNum;
        Expression *exp;
        const char *expChars, *arrayExpression;

        if ((exp = ParsingExprList::GetExpression(variableName)) == NULL)
        {
            debug1 << "ParallelAxis plot variable is neither a scalar nor an expression."
                   << endl;
            EXCEPTION1(InvalidVariableException, variableName);
        }

        expChars = exp->GetDefinition().c_str();
        
        if ((arrayExpression = strstr(expChars,"array_compose")) == NULL)
        {
            debug1 << "ParallelAxis plot input expression is not an array expression."
                   << endl;
            EXCEPTION1(ImproperUseException,
                "ParallelAxis plot input expressions must be array expressions.");
        }

        ParseArrayComponentVariables(axisNames, arrayExpression);
            
        if ((axisCount = axisNames.size()) == 0)
        {
            debug1 << "ParallelAxis plot variable is an invalid array expression."
                   << endl;
            EXCEPTION1(ImproperUseException, "Invalid array expression.");
        }
            
        if (axisCount < 2)
        {
            debug1 << "ParallelAxis plot array expression is a 1-tuple." << endl;
            EXCEPTION1(ImproperUseException,
            "ParallelAxis plot needs at least 2 input scalars for coordinate axes.");
        }
            
        for (axisNum = 0; axisNum < axisNames.size(); axisNum++)
        {
            axisMins.push_back(-1e+37); axisMaxs.push_back(+1e+37);
            extMins.push_back(0.0); extMaxs.push_back(1.0);
        }

        fallbackAtts->SetOrderedAxisNames(axisNames);
        fallbackAtts->SetAxisMinima(axisMins);
        fallbackAtts->SetAxisMaxima(axisMaxs);
        fallbackAtts->SetExtentMinima(extMins);
        fallbackAtts->SetExtentMaxima(extMaxs);
        
        initAtts = fallbackAtts;
    }
    
    if (!initAtts->AttributesAreConsistent())
    {
        debug1 << "ParallelAxis plot attributes are inconsistent." << endl;
        EXCEPTION1(ImproperUseException, 
                   "ParallelAxis plot is not set up correctly.");
    }

    *(ParallelAxisAttributes *)atts = *initAtts;
}


// ****************************************************************************
// Method: ParallelAxisViewerPluginInfo::GetVariableTypes
//
// Purpose: 
//   Returns a flag indicating the types of variables that can be put in the
//   plot's variable list.
//
// Returns:    A flag indicating the types of variables that can be put in
//             the plot's variable list.
//
//  Programmer: mblair -- generated by xml2info
//  Creation:   Mon Jun 5 18:19:57 PST 2006
//
// Modifications:
//   
// ****************************************************************************

int
ParallelAxisViewerPluginInfo::GetVariableTypes() const
{
    return VAR_CATEGORY_SCALAR | VAR_CATEGORY_ARRAY;
}


// ****************************************************************************
//  Method: ParallelAxisViewerPluginInfo::XPMIconData
//
//  Purpose:
//    Return a pointer to the icon data.
//
//  Returns:    A pointer to the icon data.
//
//  Programmer: mblair -- generated by xml2info
//  Creation:   Mon Jun 5 18:19:57 PST 2006
//
// ****************************************************************************

#include <ParallelAxis.xpm>
const char **
ParallelAxisViewerPluginInfo::XPMIconData() const
{
    return ParallelAxis_xpm;
}
