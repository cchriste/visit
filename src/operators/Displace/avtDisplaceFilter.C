// ************************************************************************* //
//  File: avtDisplaceFilter.C
// ************************************************************************* //

#include <avtDisplaceFilter.h>

#include <vtkCellData.h>
#include <vtkCellDataToPointData.h>
#include <vtkPointData.h>
#include <vtkPointSet.h>
#include <vtkWarpVector.h>

#include <avtCallback.h>

#include <ImproperUseException.h>


// ****************************************************************************
//  Method: avtDisplaceFilter constructor
//
//  Programmer: childs -- generated by xml2info
//  Creation:   Mon Nov 5 15:35:46 PST 2001
//
// ****************************************************************************

avtDisplaceFilter::avtDisplaceFilter()
{
    issuedWarning = false;
    OverrideTrueSpatialExtents();
}


// ****************************************************************************
//  Method: avtDisplaceFilter destructor
//
//  Programmer: childs -- generated by xml2info
//  Creation:   Mon Nov 5 15:35:46 PST 2001
//
//  Modifications:
//
// ****************************************************************************

avtDisplaceFilter::~avtDisplaceFilter()
{
}


// ****************************************************************************
//  Method:  avtDisplaceFilter::Create
//
//  Programmer: childs -- generated by xml2info
//  Creation:   Mon Nov 5 15:35:46 PST 2001
//
// ****************************************************************************

avtFilter *
avtDisplaceFilter::Create()
{
    return new avtDisplaceFilter();
}


// ****************************************************************************
//  Method:      avtDisplaceFilter::SetAtts
//
//  Purpose:
//      Sets the state of the filter based on the attribute object.
//
//  Arguments:
//      a        The attributes to use.
//
//  Programmer: childs -- generated by xml2info
//  Creation:   Mon Nov 5 15:35:46 PST 2001
//
// ****************************************************************************

void
avtDisplaceFilter::SetAtts(const AttributeGroup *a)
{
    atts = *(const DisplaceAttributes*)a;
    SetActiveVariable(atts.GetVariable().c_str());
}


// ****************************************************************************
//  Method: avtDisplaceFilter::Equivalent
//
//  Purpose:
//      Returns true if creating a new avtDisplaceFilter with the given
//      parameters would result in an equivalent avtDisplaceFilter.
//
//  Programmer: childs -- generated by xml2info
//  Creation:   Mon Nov 5 15:35:46 PST 2001
//
// ****************************************************************************

bool
avtDisplaceFilter::Equivalent(const AttributeGroup *a)
{
    return (atts == *(DisplaceAttributes*)a);
}


// ****************************************************************************
//  Method: avtDisplaceFilter::ExecuteData
//
//  Purpose:
//      Sends the specified input and output through the Displace filter.
//
//  Arguments:
//      in_ds      The input dataset.
//      <unused>   The domain number.
//      <unused>   The label.
//
//  Returns:       The output dataset.
//
//  Programmer: childs -- generated by xml2info
//  Creation:   Mon Nov 5 15:35:46 PST 2001
//
//  Modifications:
//    Kathleen Bonnell, Fri Feb  8 11:03:49 PST 2002
//    vtkVectors has been deprecated in VTK 4.0, use vtkDataArray instead.
//
//    Hank Childs, Wed Sep 11 08:34:03 PDT 2002
//    Fixed memory leak.
//
// ****************************************************************************

vtkDataSet *
avtDisplaceFilter::ExecuteData(vtkDataSet *in_ds, int, std::string)
{
    vtkCellDataToPointData *cd2pd = NULL;

    in_ds->GetPointData()->SetActiveVectors(atts.GetVariable().c_str());
    vtkDataArray *vecs = in_ds->GetPointData()->GetVectors();

    //
    // If we didn't get a vector variable, then see if there is a cell
    // centered vector variable and interpolate that to the nodes.
    //
    if (vecs == NULL)
    {
        cd2pd = vtkCellDataToPointData::New();
        cd2pd->SetInput(in_ds);
        cd2pd->GetOutput()->Update();
        vtkDataSet *new_in_ds = cd2pd->GetOutput();
        new_in_ds->Update();
        new_in_ds->SetSource(NULL);
        vtkPointData *pd = in_ds->GetPointData();
        for (int i = 0 ; i < pd->GetNumberOfArrays() ; i++)
        {
            new_in_ds->GetPointData()->AddArray(pd->GetArray(i));
        }

        in_ds->GetCellData()->SetActiveVectors(atts.GetVariable().c_str());
        vecs = new_in_ds->GetPointData()->GetVectors();

        if (vecs == NULL)
        {
            EXCEPTION0(ImproperUseException);
        }
        else
        {
            char msg[1024] = "Vector variable %s is a cell-centered vector."
                         "Interpolated to point-centered before displacing.";
            avtCallback::IssueWarning(msg);
            issuedWarning = true;
        }
        in_ds = new_in_ds;
    }

    vtkWarpVector *warp = vtkWarpVector::New();
    warp->SetInput((vtkPointSet *)in_ds);
    warp->SetScaleFactor(atts.GetFactor());

    //
    // Make this a dataset we can return even after we have freed memory.
    //
    vtkDataSet *rv = warp->GetOutput();
    rv->Update();
    ManageMemory(rv);

    //
    // Clean up memory.
    //
    if (cd2pd != NULL)
    {
        cd2pd->Delete();
    }
    warp->Delete();

    return rv;
}


// ****************************************************************************
//  Method: avtDisplaceFilter::RefashionDataObjectInfo
//
//  Purpose:
//    Indicates that the nodes were transformed.
//
//  Programmer: Kathleen Bonnell
//  Creation:   November 28, 2001
//
//  Modificatons:
//    Kathleen Bonnell, Mon Apr 14 09:54:06 PDT 2003
//    Set CanUseTransform to false.
//
// ****************************************************************************

void
avtDisplaceFilter::RefashionDataObjectInfo(void)
{
    GetOutput()->GetInfo().GetValidity().SetPointsWereTransformed(true);
    //
    // This operator invalidates any transform matrix in the pipeline.
    //
    GetOutput()->GetInfo().GetAttributes().SetCanUseTransform(false);
}


// ****************************************************************************
//  Method: avtDisplaceFilter::PerformRestriciton
//
//  Purpose:
//    Turn on Zone numbers flag if needed, so that original cell array
//    will be propagated throught the pipeline.
//
//  Programmer: Kathleen Bonnell
//  Creation:   November 28, 2001
//
//  Modifications:
//    Kathleen Bonnell, Wed Jun 19 12:28:10 PDT 2002 
//    Don't turn off Zone numbers if they have been turned on elsewhere in
//    the pipeline.
//
//    Kathleen Bonnell, Wed Jun 19 13:42:37 PDT 2002
//    Completely removed the code turning off zone numbers.  Why set a flag
//    to false if it is already false?  False is the default setting.
//
// ****************************************************************************

avtPipelineSpecification_p
avtDisplaceFilter::PerformRestriction(avtPipelineSpecification_p spec)
{
    avtPipelineSpecification_p rv = new avtPipelineSpecification(spec);
    if (rv->GetDataSpecification()->MayRequireZones())
    {
        rv->GetDataSpecification()->TurnZoneNumbersOn();
    }
    return rv;
}

