/****************************************************************************
*
* Copyright (c) 2000 - 2017, Lawrence Livermore National Security, LLC
* Produced at the Lawrence Livermore National Laboratory
* LLNL-CODE-442911
* All rights reserved.
*
* This file is  part of VisIt. For  details, see https://visit.llnl.gov/.  The
* full copyright notice is contained in the file COPYRIGHT located at the root
* of the VisIt distribution or at http://www.llnl.gov/visit/copyright.html.
*
* Redistribution  and  use  in  source  and  binary  forms,  with  or  without
* modification, are permitted provided that the following conditions are met:
*
*  - Redistributions of  source code must  retain the above  copyright notice,
*    this list of conditions and the disclaimer below.
*  - Redistributions in binary form must reproduce the above copyright notice,
*    this  list of  conditions  and  the  disclaimer (as noted below)  in  the
*    documentation and/or other materials provided with the distribution.
*  - Neither the name of  the LLNS/LLNL nor the names of  its contributors may
*    be used to endorse or promote products derived from this software without
*    specific prior written permission.
*
* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT  HOLDERS AND CONTRIBUTORS "AS IS"
* AND ANY EXPRESS OR  IMPLIED WARRANTIES, INCLUDING,  BUT NOT  LIMITED TO, THE
* IMPLIED WARRANTIES OF MERCHANTABILITY AND  FITNESS FOR A PARTICULAR  PURPOSE
* ARE  DISCLAIMED. IN  NO EVENT  SHALL LAWRENCE  LIVERMORE NATIONAL  SECURITY,
* LLC, THE  U.S.  DEPARTMENT OF  ENERGY  OR  CONTRIBUTORS BE  LIABLE  FOR  ANY
* DIRECT,  INDIRECT,   INCIDENTAL,   SPECIAL,   EXEMPLARY,  OR   CONSEQUENTIAL
* DAMAGES (INCLUDING, BUT NOT  LIMITED TO, PROCUREMENT OF  SUBSTITUTE GOODS OR
* SERVICES; LOSS OF  USE, DATA, OR PROFITS; OR  BUSINESS INTERRUPTION) HOWEVER
* CAUSED  AND  ON  ANY  THEORY  OF  LIABILITY,  WHETHER  IN  CONTRACT,  STRICT
* LIABILITY, OR TORT  (INCLUDING NEGLIGENCE OR OTHERWISE)  ARISING IN ANY  WAY
* OUT OF THE  USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
* DAMAGE.
*
*****************************************************************************/

#include "QvisExplodeWindow.h"

#include <ExplodeAttributes.h>
#include <DebugStream.h>

#include <QCheckBox>
#include <QLabel>
#include <QLayout>
#include <QLineEdit>
#include <QSpinBox>
#include <QButtonGroup>
#include <QRadioButton>
#include <QTabWidget>
#include <QvisVariableButton.h>

#include <QComboBox>
#include <QGroupBox>

#include <numeric>

// ****************************************************************************
// Method: QvisExplodeWindow::QvisExplodeWindow
//
// Purpose: 
//   Constructor
//
// Note:       Autogenerated by xml2window.
//
// Programmer: xml2window
// Creation:   omitted
//
// Modifications:
//   
// ****************************************************************************

QvisExplodeWindow::QvisExplodeWindow(const int type,
                         ExplodeAttributes *subj,
                         const QString &caption,
                         const QString &shortName,
                         QvisNotepadArea *notepad)
    : QvisOperatorWindow(type,subj, caption, shortName, notepad)
{
    atts = subj;
}


// ****************************************************************************
// Method: QvisExplodeWindow::~QvisExplodeWindow
//
// Purpose: 
//   Destructor
//
// Note:       Autogenerated by xml2window.
//
// Programmer: xml2window
// Creation:   omitted
//
// Modifications:
//   
// ****************************************************************************

QvisExplodeWindow::~QvisExplodeWindow()
{
}


// ****************************************************************************
// Method: QvisExplodeWindow::CreateWindowContents
//
// Purpose: 
//   Creates the widgets for the window.
//
// Note:       Autogenerated by xml2window.
//
// Programmer: xml2window
// Creation:   omitted
//
// Modifications:
//   
//    Alister Maguire, Thu Dec 21 15:46:39 PST 2017
//    Completely refactored for a better looking/acting gui. 
//
//    Alister Maguire, Mon Jan 29 10:12:44 PST 2018
//    Changed 'Explosions' title to 'Origin'. 
//
// ****************************************************************************

void
QvisExplodeWindow::CreateWindowContents()
{
    QGridLayout *mainLayout = new QGridLayout(0);
    topLayout->addLayout(mainLayout);

    QGroupBox *typeGroup = new QGroupBox(central);
    typeGroup->setTitle(tr("Origin"));
    mainLayout->addWidget(typeGroup);

    QGridLayout *typeLayout = new QGridLayout(typeGroup);
    
    explosionTabs                  = new QTabWidget(central);
    QWidget    *explosionPointTab  = new QWidget(central);
    QWidget    *explodePlaneTab    = new QWidget(central);
    QWidget    *explodeCylinderTab = new QWidget(central);
    connect(explosionTabs, SIGNAL(currentChanged(int)),
            this, SLOT(explosionTabsChangedIndex(int)));
    explosionTabs->addTab(explosionPointTab, tr("Point"));
    explosionTabs->addTab(explodePlaneTab, tr("Plane"));
    explosionTabs->addTab(explodeCylinderTab, tr("Cylinder"));
    typeLayout->addWidget(explosionTabs, 1, 0, 1, 3);
    QGridLayout *explosionPointLayout  = new QGridLayout(explosionPointTab);
    QGridLayout *explodePlaneLayout    = new QGridLayout(explodePlaneTab);
    QGridLayout *explodeCylinderLayout = new QGridLayout(explodeCylinderTab);

   
    QLabel *explosionPointLabel = new QLabel(tr("Explosion Point"), central);
    explosionPointLayout->addWidget(explosionPointLabel, 0, 0);
    explosionPoint = new QLineEdit(central);
    explosionPoint->setPlaceholderText("0.0 0.0 0.0");
    connect(explosionPoint, SIGNAL(returnPressed()),
            this, SLOT(explosionPointProcessText()));
    explosionPointLayout->addWidget(explosionPoint, 0, 1);

    QLabel *planePointLabel = new QLabel(tr("Plane Point"), central);
    explodePlaneLayout->addWidget(planePointLabel, 0, 0);
    planePoint = new QLineEdit(central);
    planePoint->setPlaceholderText("0.0 0.0 0.0");
    connect(planePoint, SIGNAL(returnPressed()),
            this, SLOT(planePointProcessText()));
    explodePlaneLayout->addWidget(planePoint, 0, 1);

    QLabel *planeNormLabel = new QLabel(tr("Plane Norm"), central);
    explodePlaneLayout->addWidget(planeNormLabel, 1, 0);
    planeNorm = new QLineEdit(central);
    planeNorm->setPlaceholderText("0.0 0.0 0.0");
    connect(planeNorm, SIGNAL(returnPressed()),
            this, SLOT(planeNormProcessText()));
    explodePlaneLayout->addWidget(planeNorm, 1, 1);

    QLabel *cylinderPoint1Label = new QLabel(tr("Cylinder Point 1"), central);
    explodeCylinderLayout->addWidget(cylinderPoint1Label, 0, 0);
    cylinderPoint1 = new QLineEdit(central);
    cylinderPoint1->setPlaceholderText("0.0 0.0 0.0");
    connect(cylinderPoint1, SIGNAL(returnPressed()),
            this, SLOT(cylinderPoint1ProcessText()));
    explodeCylinderLayout->addWidget(cylinderPoint1, 0, 1);

    QLabel *cylinderPoint2Label = new QLabel(tr("Cylinder Point 2"), central);
    explodeCylinderLayout->addWidget(cylinderPoint2Label, 1, 0);
    cylinderPoint2 = new QLineEdit(central);
    cylinderPoint2->setPlaceholderText("0.0 0.0 0.0");
    connect(cylinderPoint2, SIGNAL(returnPressed()),
            this, SLOT(cylinderPoint2ProcessText()));
    explodeCylinderLayout->addWidget(cylinderPoint2, 1, 1);

    QLabel *cylinderRadiusLabel = new QLabel(tr("Cylinder Radius"), central);
    explodeCylinderLayout->addWidget(cylinderRadiusLabel, 2, 0);
    cylinderRadius = new QLineEdit(central);
    cylinderRadius->setPlaceholderText("0.0");
    connect(cylinderRadius, SIGNAL(returnPressed()),
            this, SLOT(cylinderRadiusProcessText()));
    explodeCylinderLayout->addWidget(cylinderRadius, 2, 1);

    materialGroup = new QGroupBox(central);
    materialGroup->setTitle(tr("Material Explosion"));
    mainLayout->addWidget(materialGroup);

    QGridLayout *materialLayout = new QGridLayout(materialGroup);
    
    QLabel *materialExplosionFactorLabel = new QLabel(tr("Explosion Factor"), central);
    materialLayout->addWidget(materialExplosionFactorLabel, 2, 0);
    materialExplosionFactor = new QLineEdit(central);
    materialExplosionFactor->setPlaceholderText("0.0");
    connect(materialExplosionFactor, SIGNAL(returnPressed()),
            this, SLOT(materialExplosionFactorProcessText()));
    materialLayout->addWidget(materialExplosionFactor, 2, 1); 

    QLabel *materialsLabel  = new QLabel(tr("Available Materials"), central); 
    materialLayout->addWidget(materialsLabel, 3, 0);
    materialsWidget = new QWidget(central);
    materialsCombo  = new QComboBox(materialsWidget);
    materialLayout->addWidget(materialsCombo, 3, 1);

    QGroupBox *cellGroup = new QGroupBox(central);
    cellGroup->setTitle(tr("Cell Explosion"));
    mainLayout->addWidget(cellGroup);

    QGridLayout *cellLayout = new QGridLayout(cellGroup);

    explodeMaterialCells = new QCheckBox(tr("Explode Material Cells"), central);
    cellLayout->addWidget(explodeMaterialCells, 0, 0);
    connect(explodeMaterialCells, SIGNAL(toggled(bool)),
            this, SLOT(explodeMaterialCellsToggled(bool)));

    explodeAllCells = new QCheckBox(tr("Explode All Cells"), central);
    cellLayout->addWidget(explodeAllCells, 1, 0);
    connect(explodeAllCells, SIGNAL(toggled(bool)),
            this, SLOT(explodeAllCellsToggled(bool)));

   
    QLabel *cellExplosionFactorLabel = new QLabel(tr("Explosion Factor"), central);
    cellLayout->addWidget(cellExplosionFactorLabel, 2, 0);
    cellExplosionFactor = new QLineEdit(central);
    cellExplosionFactor->setPlaceholderText("0.0");
    cellExplosionFactor->setEnabled(false);
    connect(cellExplosionFactor, SIGNAL(returnPressed()),
            this, SLOT(cellExplosionFactorProcessText()));
    cellLayout->addWidget(cellExplosionFactor, 2, 1); 

    QLabel *patternLabel = new QLabel(tr("Explosion Pattern"), central); 
    cellLayout->addWidget(patternLabel, 3, 0);
    QWidget *patternWidget = new QWidget(central);
    explosionPattern = new QComboBox(patternWidget);
    explosionPattern->addItem("Impact");
    explosionPattern->addItem("Scatter");
    explosionPattern->setEnabled(false);
    connect(explosionPattern, SIGNAL(currentIndexChanged(int)),
            this, SLOT(explosionPatternChangedIndex(int)));
    cellLayout->addWidget(explosionPattern, 3, 1);

    boundaryString  = "";
}


// ****************************************************************************
// Method: QvisExplodeWindow::UpdateWindow
//
// Purpose: 
//   Updates the widgets in the window when the subject changes.
//
// Note:       Autogenerated by xml2window.
//
// Programmer: xml2window
// Creation:   omitted
//
// Modifications:
//
//    Alister Maguire, Thu Dec 21 15:46:39 PST 2017
//    Changed the way boundary names are updated as 
//    well as explosion type and explosion pattern. 
//   
// ****************************************************************************

void
QvisExplodeWindow::UpdateWindow(bool doAll)
{
    for(int i = 0; i < atts->NumAttributes(); ++i)
    {
        if(!doAll)
        {
            if(!atts->IsSelected(i))
            {
                continue;
            }
        }

        switch(i)
        {
            case ExplodeAttributes::ID_boundaryNames:
            {
                stringVector materials = atts->GetBoundaryNames();
                std::string tmp;
                tmp = std::accumulate(materials.begin(), materials.end(), tmp);

                if (tmp.empty())
                {
                    materialGroup->setEnabled(false);
                    explodeMaterialCells->setEnabled(false);
                }
                else if (tmp != boundaryString)
                {
                    materialGroup->setEnabled(true);
                    explodeMaterialCells->setEnabled(true);

                    boundaryString = tmp;
                    int numMaterials = atts->GetBoundaryNames().size();          
          
                    materialsCombo->blockSignals(true);
                    materialsCombo->clear();
                    materialsCombo->blockSignals(false);

                    for(size_t idx = 0; idx < numMaterials; ++idx)
                    {
                        const char *name = atts->GetBoundaryNames()[idx].c_str();
                        materialsCombo->blockSignals(true);
                        materialsCombo->addItem(name);
                        materialsCombo->blockSignals(false);
                    }
                }
                else
                {
                    int selectedIdx    = 0;
                    std::string selectedMat = atts->GetMaterial();
                    int numMaterials = atts->GetBoundaryNames().size();          
                    for(size_t idx = 0; idx < numMaterials; ++idx)
                    {
                        const char *name = atts->GetBoundaryNames()[idx].c_str();
                        if (name == selectedMat)
                        {
                            selectedIdx = idx;
                        }
                        materialsCombo->setCurrentIndex(selectedIdx);
                    }
                }
            }
            break;
          case ExplodeAttributes::ID_explosionPoint:
              explosionPoint->setText(DoublesToQString(atts->GetExplosionPoint(), 3));
              break;
          case ExplodeAttributes::ID_planePoint:
              planePoint->setText(DoublesToQString(atts->GetPlanePoint(), 3));
              break;
          case ExplodeAttributes::ID_planeNorm:
              planeNorm->setText(DoublesToQString(atts->GetPlaneNorm(), 3));
              break;
          case ExplodeAttributes::ID_cylinderPoint1:
              cylinderPoint1->setText(DoublesToQString(atts->GetCylinderPoint1(), 3));
              break;
          case ExplodeAttributes::ID_cylinderPoint2:
              cylinderPoint2->setText(DoublesToQString(atts->GetCylinderPoint2(), 3));
              break;
          case ExplodeAttributes::ID_materialExplosionFactor:
              materialExplosionFactor->setText(DoubleToQString(atts->GetMaterialExplosionFactor()));
              break;
          case ExplodeAttributes::ID_explodeMaterialCells:
              explodeMaterialCells->setChecked(atts->GetExplodeMaterialCells());
              break;
          case ExplodeAttributes::ID_explodeAllCells:
              explodeAllCells->setChecked(atts->GetExplodeAllCells());
              break;
          case ExplodeAttributes::ID_cellExplosionFactor:
              cellExplosionFactor->setText(DoubleToQString(atts->GetCellExplosionFactor()));
              break;
          case ExplodeAttributes::ID_cylinderRadius:
              cylinderRadius->setText(DoubleToQString(atts->GetCylinderRadius()));
              break;
          case ExplodeAttributes::ID_explosionPattern:
          {
              int patternID = atts->GetExplosionPattern();
              switch (patternID)
              {
                  case ExplodeAttributes::Impact:
                  {
                      explosionPattern->setCurrentIndex(IMPACT);
                  }
                  break;
                  case ExplodeAttributes::Scatter:
                  {
                      explosionPattern->setCurrentIndex(SCATTER);
                  }
                  break;
              }
              break;
          }
          case ExplodeAttributes::ID_explosionType:
          {
              int typeID = atts->GetExplosionType();
              switch (typeID)
              {
                  case ExplodeAttributes::Point:
                  {
                    explosionTabs->setCurrentIndex(POINT);
                  }
                  break;
                  case ExplodeAttributes::Plane:
                  {
                    explosionTabs->setCurrentIndex(PLANE);
                  }
                  break;
                  case ExplodeAttributes::Cylinder:
                  {
                    explosionTabs->setCurrentIndex(CYLINDER);
                  }
                  break;
              }
          }
      }
   }
}


// ****************************************************************************
// Method: QvisExplodeWindow::GetCurrentValues
//
// Purpose: 
//   Gets values from certain widgets and stores them in the subject.
//
// Note:       Autogenerated by xml2window.
//
// Programmer: xml2window
// Creation:   omitted
//
// Modifications:
//   
// ****************************************************************************

void
QvisExplodeWindow::GetCurrentValues(int which_widget)
{

    bool doAll = (which_widget == -1);

    // Do explosionPoint
    if(which_widget == ExplodeAttributes::ID_explosionPoint || doAll)
    {
        double val[3];
        if(LineEditGetDoubles(explosionPoint, val, 3))
            atts->SetExplosionPoint(val);
        else
        {
            ResettingError(tr("explosionPoint"),
                DoublesToQString(atts->GetExplosionPoint(),3));
            atts->SetExplosionPoint(atts->GetExplosionPoint());
        }
    }

    // Do planePoint
    if(which_widget == ExplodeAttributes::ID_planePoint || doAll)
    {
        double val[3];
        if(LineEditGetDoubles(planePoint, val, 3))
            atts->SetPlanePoint(val);
        else
        {
            ResettingError(tr("planePoint"),
                DoublesToQString(atts->GetPlanePoint(),3));
            atts->SetPlanePoint(atts->GetPlanePoint());
        }
    }

    // Do planeNorm
    if(which_widget == ExplodeAttributes::ID_planeNorm || doAll)
    {
        double val[3];
        if(LineEditGetDoubles(planeNorm, val, 3))
            atts->SetPlaneNorm(val);
        else
        {
            ResettingError(tr("planeNorm"),
                DoublesToQString(atts->GetPlaneNorm(),3));
            atts->SetPlaneNorm(atts->GetPlaneNorm());
        }
    }

    // Do cylinderPoint1
    if(which_widget == ExplodeAttributes::ID_cylinderPoint1 || doAll)
    {
        double val[3];
        if(LineEditGetDoubles(cylinderPoint1, val, 3))
            atts->SetCylinderPoint1(val);
        else
        {
            ResettingError(tr("cylinderPoint1"),
                DoublesToQString(atts->GetCylinderPoint1(),3));
            atts->SetCylinderPoint1(atts->GetCylinderPoint1());
        }
    }

    // Do cylinderPoint2
    if(which_widget == ExplodeAttributes::ID_cylinderPoint2 || doAll)
    {
        double val[3];
        if(LineEditGetDoubles(cylinderPoint2, val, 3))
            atts->SetCylinderPoint2(val);
        else
        {
            ResettingError(tr("cylinderPoint2"),
                DoublesToQString(atts->GetCylinderPoint2(),3));
            atts->SetCylinderPoint2(atts->GetCylinderPoint2());
        }
    }

    // Do materialExplosionFactor
    if(which_widget == ExplodeAttributes::ID_materialExplosionFactor || doAll)
    {
        double val;
        if(LineEditGetDouble(materialExplosionFactor, val))
            atts->SetMaterialExplosionFactor(val);
        else
        {
            ResettingError(tr("materialExplosionFactor"),
                DoubleToQString(atts->GetMaterialExplosionFactor()));
            atts->SetMaterialExplosionFactor(atts->GetMaterialExplosionFactor());
        }
    }

    // Do cellExplosionFactor
    if(which_widget == ExplodeAttributes::ID_cellExplosionFactor || doAll)
    {
        double val;
        if(LineEditGetDouble(cellExplosionFactor, val))
            atts->SetCellExplosionFactor(val);
        else
        {
            ResettingError(tr("cellExplosionFactor"),
                DoubleToQString(atts->GetCellExplosionFactor()));
            atts->SetCellExplosionFactor(atts->GetCellExplosionFactor());
        }
    }

    // Do materials
    if(which_widget == ExplodeAttributes::ID_material || doAll)
    {
        atts->SetMaterial(materialsCombo->currentText().toStdString());
    }

    // Do cylinderRadius
    if(which_widget == ExplodeAttributes::ID_cylinderRadius || doAll)
    {
        double val;
        if(LineEditGetDouble(cylinderRadius, val))
            atts->SetCylinderRadius(val);
        else
        {
            ResettingError(tr("cylinderRadius"),
                DoubleToQString(atts->GetCylinderRadius()));
            atts->SetCylinderRadius(atts->GetCylinderRadius());
        }
    }
}


//
// Qt Slot functions
//

void
QvisExplodeWindow::explosionTabsChangedIndex(int type)
{
    // Do explosionType
    if(type != atts->GetExplosionType())
    {
        switch (type)
        {
            case POINT:
            {
                atts->SetExplosionType(ExplodeAttributes::Point);
            }
            break;
            case PLANE:
            {
                atts->SetExplosionType(ExplodeAttributes::Plane);
            }
            break;
            case CYLINDER:
            {
                atts->SetExplosionType(ExplodeAttributes::Cylinder);
            }
            break;
        }
        SetUpdate(false);
        Apply();
    }
    Apply();
}


void
QvisExplodeWindow::explosionPatternChangedIndex(int type)
{
    // Do explosionPattern
    if(type != atts->GetExplosionPattern())
    {
        switch (type)
        {
            case IMPACT:
            {
                atts->SetExplosionPattern(ExplodeAttributes::Impact);
            }
            break;
            case SCATTER:
            {
                atts->SetExplosionPattern(ExplodeAttributes::Scatter);
            }
            break;
        }
        SetUpdate(false);
    }
    Apply();
}


void
QvisExplodeWindow::explosionPointProcessText()
{
    GetCurrentValues(ExplodeAttributes::ID_explosionPoint);
    Apply();
}


void
QvisExplodeWindow::planePointProcessText()
{
    GetCurrentValues(ExplodeAttributes::ID_planePoint);
    Apply();
}


void
QvisExplodeWindow::planeNormProcessText()
{
    GetCurrentValues(ExplodeAttributes::ID_planeNorm);
    Apply();
}


void
QvisExplodeWindow::cylinderPoint1ProcessText()
{
    GetCurrentValues(ExplodeAttributes::ID_cylinderPoint1);
    Apply();
}


void
QvisExplodeWindow::cylinderPoint2ProcessText()
{
    GetCurrentValues(ExplodeAttributes::ID_cylinderPoint2);
    Apply();
}


void
QvisExplodeWindow::materialExplosionFactorProcessText()
{
    GetCurrentValues(ExplodeAttributes::ID_materialExplosionFactor);
    Apply();
}


void
QvisExplodeWindow::cellExplosionFactorProcessText()
{
    GetCurrentValues(ExplodeAttributes::ID_cellExplosionFactor);
    Apply();
}


void
QvisExplodeWindow::materialProcessText()
{
    GetCurrentValues(ExplodeAttributes::ID_material);
    Apply();
}


void
QvisExplodeWindow::cylinderRadiusProcessText()
{
    GetCurrentValues(ExplodeAttributes::ID_cylinderRadius);
    Apply();
}

void 
QvisExplodeWindow::explodeMaterialCellsToggled(bool val)
{
    cellExplosionFactor->setEnabled(val);
    explosionPattern->setEnabled(val);
    explodeAllCells->setEnabled(!val);
    atts->SetExplodeMaterialCells(val); 
    Apply();
}

void 
QvisExplodeWindow::explodeAllCellsToggled(bool val)
{
    cellExplosionFactor->setEnabled(val);
    explosionPattern->setEnabled(val);
    materialGroup->setEnabled(!val);
    explodeMaterialCells->setEnabled(!val);
    atts->SetExplodeAllCells(val); 
    Apply();
}


